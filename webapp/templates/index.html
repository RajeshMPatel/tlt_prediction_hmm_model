<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TLT / VIX H5 Today Card</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f6f8fb; color: #1f2937; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); padding: 20px; max-width: 980px; }
    h1 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 12px; }
    .tile { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    .k { font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 6px; }
    .v { font-size: 24px; font-weight: 700; }
    .muted { color: #6b7280; }
    .signal-grid { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 12px; margin: 12px 0 8px; }
    .signal { border-radius: 10px; border: 1px solid #e5e7eb; padding: 12px; background: #f9fafb; }
    .signal-action { font-size: 22px; font-weight: 800; margin: 6px 0; }
    .signal-meta { font-size: 13px; color: #4b5563; margin-top: 6px; line-height: 1.4; }
    .strong { color: #0f766e; }
    .moderate { color: #1d4ed8; }
    .skip { color: #b45309; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; vertical-align: top; text-align: left; }
    th { background: #f3f4f6; font-weight: 700; }
    .tight-list { margin: 0; padding-left: 18px; }
    .tight-list li { margin: 2px 0; }
    .pill { display: inline-block; border-radius: 999px; padding: 2px 8px; font-size: 12px; font-weight: 700; margin-right: 6px; }
    .pill-bull { background: #dcfce7; color: #166534; }
    .pill-bear { background: #fee2e2; color: #991b1b; }
    .pill-neutral { background: #e5e7eb; color: #374151; }
    .howto { margin-top: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 12px; font-size: 13px; color: #374151; }
    .current-row { background: #fff7ed; }
    .current-row td { border-color: #fdba74; }
    .bridge { margin: 12px 0 14px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 12px; font-size: 13px; color: #1e3a8a; }
    .bridge h4 { margin: 0 0 8px; color: #1e40af; }
    ul { margin-top: 8px; }
    .explainer { margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 20px; color: #4b5563; }
    .explainer h3 { color: #1f2937; margin-bottom: 12px; }
    .explainer p { margin: 8px 0; line-height: 1.5; }
    .explainer ul { margin: 8px 0; padding-left: 20px; }
    .explainer li { margin-bottom: 6px; }
    .explainer strong { color: #374151; }
    .sentiment-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 6px; }
    .sentiment-fill { height: 100%; background: #6b7280; }
    .sentiment-fill.fear { background: #ef4444; }
    .sentiment-fill.greed { background: #22c55e; }
    .sentiment-fill.neutral { background: #eab308; }
  </style>
</head>
<body>
  <div class="card">
    <h1>TLT / VIX H5 Probabilities</h1>
    {% if has_data %}
      <p class="muted">Date: <strong>{{ payload.date }}</strong> (H5 = Forecast for next 5 trading days)</p>
      <div class="grid">
        <div class="tile"><div class="k">P(TLT up H5)</div><div class="v">{{ "%.2f%%"|format(payload.probabilities.tlt_up_h5 * 100) }}</div></div>
        <div class="tile"><div class="k">P(TLT down H5)</div><div class="v">{{ "%.2f%%"|format(payload.probabilities.tlt_down_h5 * 100) }}</div></div>
        <div class="tile"><div class="k">P(VIX up H5)</div><div class="v">{{ "%.2f%%"|format(payload.probabilities.vix_up_h5 * 100) }}</div></div>
        <div class="tile"><div class="k">P(VIX down H5)</div><div class="v">{{ "%.2f%%"|format(payload.probabilities.vix_down_h5 * 100) }}</div></div>
      </div>
      
      {% if payload.market_context.synthetic_fear_greed is not none %}
      {% set sentiment = payload.market_context.synthetic_fear_greed %}
      {% set sentiment_cls = 'neutral' %}
      {% if sentiment <= 45 %}{% set sentiment_cls = 'fear' %}{% endif %}
      {% if sentiment >= 55 %}{% set sentiment_cls = 'greed' %}{% endif %}
      <div class="grid" style="margin-top: 12px; grid-template-columns: 1fr;">
        <div class="tile">
          <div class="k">Synthetic Fear & Greed Index</div>
          <div class="v" style="font-size: 20px;">
            {{ "%.0f"|format(sentiment) }} 
            <span style="font-size: 14px; color: #6b7280; font-weight: 400;">
              {% if sentiment <= 25 %}(Extreme Fear){% elif sentiment <= 45 %}(Fear){% elif sentiment >= 75 %}(Extreme Greed){% elif sentiment >= 55 %}(Greed){% else %}(Neutral){% endif %}
            </span>
          </div>
          <div class="sentiment-bar">
            <div class="sentiment-fill {{ sentiment_cls }}" style="width: {{ sentiment }}%;"></div>
          </div>
        </div>
      </div>
      {% endif %}

      {% if payload.actionable_signals and payload.actionable_signals.policy_enabled %}
      <h3>Today Action Signals</h3>
      <div class="signal-grid">
        {% set tlt_signal = payload.actionable_signals.tlt %}
        {% set tlt_class = 'skip' %}
        {% if tlt_signal.action.startswith('STRONG') %}{% set tlt_class = 'strong' %}{% endif %}
        {% if tlt_signal.action.startswith('MODERATE') %}{% set tlt_class = 'moderate' %}{% endif %}
        <div class="signal">
          <div class="k">TLT Signal</div>
          <div class="signal-action {{ tlt_class }}">{{ tlt_signal.action }}</div>
          <div class="signal-meta">
            Confidence: {{ "%.2f%%"|format(tlt_signal.confidence * 100) if tlt_signal.confidence is not none else "N/A" }}<br/>
            {% if tlt_signal.expected_hit_rate is not none %}
            Recent hit rate at this confidence: {{ "%.2f%%"|format(tlt_signal.expected_hit_rate * 100) }}<br/>
            Coverage: {{ "%.2f%%"|format(tlt_signal.coverage * 100) }}
            {% else %}
            Reason: 
            {% if tlt_signal.reason == "no_valid_confidence_bucket" %}
              Either the signal is too weak (<55%), or when we tried this signal in the past year, it lost money.
            {% elif tlt_signal.reason == "probability_too_close_to_50_50" %}
              Probability is a coin flip (near 50/50).
            {% elif tlt_signal.reason == "backtest_unavailable" %}
              Backtest data unavailable.
            {% else %}
              {{ tlt_signal.reason }}
            {% endif %}
            {% endif %}
          </div>
        </div>

        {% set vix_signal = payload.actionable_signals.vix %}
        {% set vix_class = 'skip' %}
        {% if vix_signal.action.startswith('STRONG') %}{% set vix_class = 'strong' %}{% endif %}
        {% if vix_signal.action.startswith('MODERATE') %}{% set vix_class = 'moderate' %}{% endif %}
        <div class="signal">
          <div class="k">VIX Signal</div>
          <div class="signal-action {{ vix_class }}">{{ vix_signal.action }}</div>
          <div class="signal-meta">
            Confidence: {{ "%.2f%%"|format(vix_signal.confidence * 100) if vix_signal.confidence is not none else "N/A" }}<br/>
            {% if vix_signal.expected_hit_rate is not none %}
            Recent hit rate at this confidence: {{ "%.2f%%"|format(vix_signal.expected_hit_rate * 100) }}<br/>
            Coverage: {{ "%.2f%%"|format(vix_signal.coverage * 100) }}
            {% else %}
            Reason: 
            {% if vix_signal.reason == "no_valid_confidence_bucket" %}
              Either the signal is too weak (<55%), or when we tried this signal in the past year, it lost money.
            {% elif vix_signal.reason == "probability_too_close_to_50_50" %}
              Probability is a coin flip (near 50/50).
            {% elif vix_signal.reason == "backtest_unavailable" %}
              Backtest data unavailable.
            {% else %}
              {{ vix_signal.reason }}
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <p class="muted">Interpretation: STRONG = highest-confidence setup, MODERATE = usable edge, SKIP = no reliable edge today.</p>
      {% endif %}

      <h3>Current Regime</h3>
      <div class="howto">
        <strong>How to read:</strong> Start with <em>Status</em> and <em>Description</em>. Then use <em>What this suggests</em> for plain-English direction and <em>Evidence</em> for underlying metrics.
      </div>
      <div class="bridge">
        <h4>How current regime translates to actionable signals</h4>
        <ul class="tight-list">
          <li>
            Current regime context: <strong>{{ payload.most_likely_regime }}</strong>
            {% set cur_prob = payload.regime_probabilities[payload.most_likely_regime] if payload.regime_probabilities and payload.most_likely_regime in payload.regime_probabilities else none %}
            {% if cur_prob is not none %}
            ({{ "%.2f%%"|format(cur_prob * 100) }} probability)
            {% endif %}.
            This describes the market state, not a direct trade.
          </li>
          {% if payload.actionable_signals and payload.actionable_signals.tlt %}
          {% set s = payload.actionable_signals.tlt %}
          <li>
            <strong>TLT action:</strong> {{ s.action }}.
            Regime context is combined with current probability ({{ "%.2f%%"|format(s.confidence * 100) if s.confidence is not none else "N/A" }} confidence)
            {% if s.expected_hit_rate is not none %}
            and recent out-of-sample hit rate ({{ "%.2f%%"|format(s.expected_hit_rate * 100) }}) at this confidence level.
            {% else %}
            and confidence-bucket checks; result is {{ s.reason }}.
            {% endif %}
          </li>
          {% endif %}
          {% if payload.actionable_signals and payload.actionable_signals.vix %}
          {% set s = payload.actionable_signals.vix %}
          <li>
            <strong>VIX action:</strong> {{ s.action }}.
            Regime context is combined with current probability ({{ "%.2f%%"|format(s.confidence * 100) if s.confidence is not none else "N/A" }} confidence)
            {% if s.expected_hit_rate is not none %}
            and recent out-of-sample hit rate ({{ "%.2f%%"|format(s.expected_hit_rate * 100) }}) at this confidence level.
            {% else %}
            and confidence-bucket checks; result is {{ s.reason }}.
            {% endif %}
          </li>
          {% endif %}
        </ul>
      </div>
      <table>
        <thead>
          <tr>
            <th>Regime Name</th>
            <th>Probability</th>
            <th>Volatility (20d)</th>
            <th>Status</th>
            <th>Description</th>
            <th>What this suggests</th>
            <th>Evidence</th>
          </tr>
        </thead>
        <tbody>
          {% for regime_name, regime_prob in payload.regime_probabilities.items() %}
          {% set regime_def = payload.regime_definitions[regime_name] if payload.regime_definitions and regime_name in payload.regime_definitions else {} %}
          <tr class="{% if regime_name == payload.most_likely_regime %}current-row{% endif %}">
            <td>{{ regime_name }}</td>
            <td>{{ "%.2f%%"|format(regime_prob * 100) }}</td>
            <td>
              {% if regime_def and regime_def.avg_realized_vol_20d is not none %}
              {{ "%.2f%%"|format(regime_def.avg_realized_vol_20d * 100) }}
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>{{ regime_def.status if regime_def and regime_def.status else "N/A" }}</td>
            <td>{{ regime_def.interpretation if regime_def and regime_def.interpretation else "N/A" }}</td>
            <td>
              {% if regime_def and regime_def.technical_takeaways %}
              <ul class="tight-list">
                {% for item in regime_def.technical_takeaways %}
                {% set low = item|lower %}
                <li>
                  {% if "bullish" in low %}
                  <span class="pill pill-bull">Bullish</span>
                  {% elif "bearish" in low %}
                  <span class="pill pill-bear">Bearish</span>
                  {% else %}
                  <span class="pill pill-neutral">Neutral</span>
                  {% endif %}
                  {{ item }}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>
              {% if regime_def and regime_def.technical_reason_bullets %}
              <ul class="tight-list">
                {% for item in regime_def.technical_reason_bullets %}
                <li>{{ item }}</li>
                {% endfor %}
              </ul>
              {% else %}
              {{ regime_def.technical_reason if regime_def and regime_def.technical_reason else "N/A" }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <p class="muted">Most likely regime: <strong>{{ payload.most_likely_regime }}</strong></p>
      <p class="muted">Last data update: <strong>{{ payload.last_data_update }}</strong></p>
      <p class="muted">Generated at (UTC): <strong>{{ payload.generated_at_utc }}</strong></p>
      <p><a href="/status">View status/debug page</a></p>

      <div class="explainer">
        <h3>How the Model Works</h3>
        <p>Think of the HMM model like a <strong>Doctor diagnosing a patient</strong>.</p>
        
        <p><strong>1. The Symptoms (Technical Indicators)</strong><br>
        The "Technical Indicators" you see (RSI, Volatility, Trend Gap, Credit Spreads, <strong>Sentiment</strong>, <strong>Dollar</strong>) are the symptoms. The model looks at all of them at once as a single "health profile" for the day.</p>
        
        <p><strong>2. The Diagnosis (Deciding the Regime)</strong><br>
        The "Regime" is the medical condition. The model has studied 15+ years of history and learned that the market usually exists in one of 3 states (clusters):</p>
        <ul>
          <li><strong>Regime 1 (e.g., Healthy/Calm):</strong> Historically defined by Low Volatility + Stable Trends + Normal Spreads.</li>
          <li><strong>Regime 2 (e.g., Fever/Crash):</strong> Historically defined by High Volatility + Spiking Spreads + Oversold RSI.</li>
          <li><strong>Regime 3 (e.g., Mixed/Choppy):</strong> Everything else.</li>
        </ul>
        <p>It compares today's "symptoms" against these definitions to decide the current regime (e.g., "Today matches Regime 1 with 98% certainty").</p>

        <p><strong>3. The Prognosis ("H5" = Next 5 Days)</strong><br>
        "H5" stands for the <strong>5-day forecast horizon</strong> (one trading week). The model predicts the probability of the price being higher or lower 5 days from now, rather than just tomorrow. This captures swing trends rather than daily noise.</p>

        <p>The HMM predicts by <strong>historical precedent</strong> using an <strong>Ensemble Consensus</strong>. We train 10 slightly different versions of the model (like getting 10 second opinions). Once they diagnose the regime, they vote:</p>
        <ul>
          <li>Each model calculates the historical win rate for its diagnosed regime.</li>
          <li>We average all 10 predictions to get the final probability. This reduces noise and makes the signal more stable.</li>
        </ul>

        <p><strong>Why is this better than just using RSI?</strong><br>
        A simple RSI rule says: "If RSI > 70, Sell." The HMM says: "If RSI > 70 <strong>BUT</strong> Volatility is Low and Spreads are Tight (Regime 1), that's actually a <strong>strong uptrend</strong>, so Buy." It captures the <strong>context</strong> that a single indicator misses.</p>
      </div>
    {% else %}
      <p>No daily probabilities found yet. Run <code>bash scripts/run_pipeline.sh</code>.</p>
    {% endif %}
  </div>
</body>
</html>
